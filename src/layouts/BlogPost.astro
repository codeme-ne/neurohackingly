---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import type { CollectionEntry } from "astro:content";
import SEO from "../components/SEO.astro";
import ScrollProgress from "../components/ScrollProgress.astro";
import MinimalNav from "../components/MinimalNav.astro";
import Footer from "../components/Footer.astro";
import RelatedPosts from "../components/RelatedPosts.astro";
import ShareButtons from "../components/ShareButtons.astro";
import "../styles/global.css";
import ThemeScript from "../components/ThemeScript.astro";
import TableOfContents from "../components/TableOfContents.astro";
import ImageLightbox from "../components/ImageLightbox.astro";
import type { MarkdownHeading } from "astro";

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  author: string;
  image?: { url: string; alt: string };
  hero?: ImageMetadata;
  tags?: string[];
  readingTime?: number;
  topics?: string[];
  headings?: MarkdownHeading[];
  slug: string;
  allPosts: CollectionEntry<"blog">[];
}

const {
  title,
  description,
  pubDate: rawPubDate,
  updatedDate: rawUpdatedDate,
  author,
  image,
  hero,
  tags = [],
  readingTime: frontmatterReadingTime,
  topics = [],
  headings = [],
  slug,
  allPosts,
} = Astro.props;

// Trust Zod schema - dates are already validated
const pubDate = rawPubDate;
const updatedDate = rawUpdatedDate;

if (!pubDate) {
  throw new Error("BlogPost layout requires a pubDate for blog content.");
}

// Reading time calculation
const WORDS_PER_MINUTE = 200;
const content = await Astro.slots.render("default");
const wordCount = content.split(/\s+/).length;
const computedReadingTime = Math.ceil(wordCount / WORDS_PER_MINUTE);
const readingMinutes =
  typeof frontmatterReadingTime === "number" && frontmatterReadingTime > 0
    ? Math.round(frontmatterReadingTime)
    : computedReadingTime;

const isGerman = Astro.url.pathname.startsWith("/de");
const locale = isGerman ? "de-DE" : "en-US";

const authorSocials = {
  twitter: "@neurohackingly",
  linkedin: "https://www.linkedin.com/in/lukzan",
  github: "https://github.com/codeme-ne",
  website: "https://neurohackingly.com",
};

const authorSameAs = Array.from(
  new Set(
    [
      authorSocials.twitter
        ? `https://twitter.com/${authorSocials.twitter.replace("@", "")}`
        : undefined,
      authorSocials.linkedin,
      authorSocials.github,
      authorSocials.website,
    ].filter(Boolean),
  ),
);

const mergedTags = Array.from(new Set([...tags, ...topics]));
const baseCategory = topics[0] ?? tags[0] ?? "blog";
const primaryTopic = baseCategory.toLowerCase();
const timeRequired = `PT${Math.max(1, readingMinutes)}M`;
const publisherLogo = Astro.site
  ? new URL("/images/og/default.svg", Astro.site).href
  : "https://neurohackingly.com/images/og/default.svg";

// Schema.org structured data
const effectiveModifiedDate = updatedDate ?? pubDate;

const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description,
  image: image?.url,
  ...(pubDate && { datePublished: pubDate.toISOString() }),
  ...(effectiveModifiedDate && {
    dateModified: effectiveModifiedDate.toISOString(),
  }),
  inLanguage: locale,
  timeRequired,
  wordCount,
  ...(mergedTags.length > 0 && { keywords: mergedTags.join(", ") }),
  ...(topics.length > 0 && {
    about: topics.map((topic) => ({
      "@type": "Thing",
      name: topic,
    })),
  }),
  ...(primaryTopic && { articleSection: primaryTopic }),
  author: {
    "@type": "Person",
    name: author,
    url: authorSocials.website,
    sameAs: authorSameAs,
  },
  publisher: {
    "@type": "Organization",
    name: "Neurohackingly",
    logo: {
      "@type": "ImageObject",
      url: publisherLogo,
    },
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": Astro.url.href,
  },
};
---

<!doctype html>
<html lang={isGerman ? "de" : "en"}>
  <head>
    <SEO
      title={`${title} | Neurohackingly`}
      description={description}
      image={image?.url}
      imageAlt={image?.alt}
      article={true}
      publishedTime={pubDate}
      modifiedTime={updatedDate}
      tags={mergedTags}
      category={primaryTopic}
      authorSocials={authorSocials}
      structuredData={[schema]}
    />
    <ThemeScript />
  </head>
  <body>
    <ScrollProgress />
    <MinimalNav />

    <main>
      <article data-pagefind-body>
        <header data-pagefind-ignore>
          {
            hero ? (
              <Image
                src={hero}
                alt={image?.alt ?? ""}
                widths={[720, 1024, 1440]}
                sizes="(max-width: 720px) 100vw, 720px"
                class="feature-image"
                loading="eager"
                decoding="async"
              />
            ) : (
              image && (
                <img
                  src={image.url}
                  alt={image.alt}
                  class="feature-image"
                  loading="eager"
                  decoding="async"
                />
              )
            )
          }
          <h1 data-pagefind-meta="title">{title}</h1>
          <div
            class="meta"
            data-pagefind-meta="date[content]"
            content={pubDate.toISOString()}
          >
            <time datetime={pubDate.toISOString()}>
              {
                pubDate.toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })
              }
            </time>
            <span>·</span>
            <span>{readingMinutes} min read</span>
            <span>·</span>
            <span>{author}</span>
          </div>
          {
            tags.length > 0 && (
              <div
                class="tags"
                data-pagefind-meta="tags[content]"
                content={tags.join(", ")}
              >
                {tags
                  .filter((t) => !t.toLowerCase().startsWith("hash-"))
                  .map((tag) => (
                    <a href={`/tag/${encodeURIComponent(tag)}`} class="tag">
                      #{tag}
                    </a>
                  ))}
              </div>
            )
          }
        </header>

        <div class="content">
          <slot />
        </div>

        <ShareButtons url={Astro.url.href} title={title} />
      </article>

      <RelatedPosts currentSlug={slug} currentTags={tags} allPosts={allPosts} />

      <TableOfContents headings={headings} />
      <Footer />
    </main>

    <ImageLightbox />

    <script>
      // SVG Icons for copy button
      const COPY_ICON = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
      const CHECK_ICON = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;

      function initCopyButtons() {
        const codeBlocks = document.querySelectorAll('article .content pre');

        codeBlocks.forEach((pre) => {
          if (pre.querySelector('.copy-button')) return;

          const button = document.createElement('button');
          button.className = 'copy-button';
          button.innerHTML = COPY_ICON;
          button.setAttribute('aria-label', 'Copy code to clipboard');

          button.addEventListener('click', async () => {
            const code = pre.querySelector('code');
            if (!code) return;

            try {
              await navigator.clipboard.writeText(code.textContent || '');
              button.innerHTML = CHECK_ICON;
              button.classList.add('copied');

              setTimeout(() => {
                button.innerHTML = COPY_ICON;
                button.classList.remove('copied');
              }, 2000);
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          });

          pre.appendChild(button);
        });
      }

      initCopyButtons();
      document.addEventListener('astro:page-load', initCopyButtons);
    </script>
  </body>
</html>
