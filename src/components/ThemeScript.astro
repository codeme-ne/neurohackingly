---
/*
  ThemeScript.astro
  Handles theme initialization and toggling with View Transitions API support.
*/
---

<script is:inline>
    // Initialize theme
    const getTheme = () =>
        localStorage.getItem("theme") ||
        (window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light");

    document.documentElement.setAttribute("data-theme", getTheme());

    // Toggle theme function
    window.toggleTheme = (event) => {
        const current = document.documentElement.getAttribute("data-theme");
        const next = current === "light" ? "dark" : "light";

        // Fallback for browsers without View Transitions
        if (!document.startViewTransition) {
            document.documentElement.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);
            return;
        }

        // Get click coordinates or center of screen if no event
        const x = event?.clientX ?? window.innerWidth / 2;
        const y = event?.clientY ?? window.innerHeight / 2;

        // Calculate distance to the farthest corner
        const endRadius = Math.hypot(
            Math.max(x, window.innerWidth - x),
            Math.max(y, window.innerHeight - y),
        );

        const isDark = next === 'dark';

        // Set transition direction class BEFORE starting transition
        document.documentElement.classList.add(isDark ? 'transitioning-to-dark' : 'transitioning-to-light');

        // Start the transition
        const transition = document.startViewTransition(() => {
            document.documentElement.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);
        });

        // Animate the circular clip path
        // Light mode: expand outward (inside → outside)
        // Dark mode: contract inward (outside → inside)
        transition.ready.then(() => {
            const clipPath = isDark
                ? [`circle(${endRadius}px at ${x}px ${y}px)`, `circle(0px at ${x}px ${y}px)`]
                : [`circle(0px at ${x}px ${y}px)`, `circle(${endRadius}px at ${x}px ${y}px)`];

            document.documentElement.animate(
                { clipPath },
                {
                    duration: 500,
                    easing: "ease-in-out",
                    pseudoElement: isDark
                        ? "::view-transition-old(root)"
                        : "::view-transition-new(root)",
                },
            );
        });

        // Clean up transition class when done
        transition.finished.then(() => {
            document.documentElement.classList.remove('transitioning-to-dark', 'transitioning-to-light');
        });
    };
</script>

<style is:global>
    /* Disable default view transition animations so we can use custom clip-path */
    ::view-transition-old(root),
    ::view-transition-new(root) {
        animation: none;
        mix-blend-mode: normal;
    }

    /* To light (expand): new view on top, expands to cover old */
    :root.transitioning-to-light ::view-transition-new(root) {
        z-index: 2;
    }
    :root.transitioning-to-light ::view-transition-old(root) {
        z-index: 1;
    }

    /* To dark (contract): old view on top, contracts to reveal new */
    :root.transitioning-to-dark ::view-transition-old(root) {
        z-index: 2;
    }
    :root.transitioning-to-dark ::view-transition-new(root) {
        z-index: 1;
    }
</style>
