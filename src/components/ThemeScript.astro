---
/*
  ThemeScript.astro
  Handles theme initialization and toggling with View Transitions API support.
*/
---

<script is:inline>
    // Initialize theme
    const getTheme = () =>
        localStorage.getItem("theme") ||
        (window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light");

    document.documentElement.setAttribute("data-theme", getTheme());

    // Toggle theme function
    window.toggleTheme = (event) => {
        const current = document.documentElement.getAttribute("data-theme");
        const next = current === "light" ? "dark" : "light";

        // Fallback for browsers without View Transitions
        if (!document.startViewTransition) {
            document.documentElement.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);
            return;
        }

        // Get click coordinates or center of screen if no event
        const x = event?.clientX ?? window.innerWidth / 2;
        const y = event?.clientY ?? window.innerHeight / 2;

        // Calculate distance to the farthest corner
        const endRadius = Math.hypot(
            Math.max(x, window.innerWidth - x),
            Math.max(y, window.innerHeight - y),
        );

        // Start the transition
        const transition = document.startViewTransition(() => {
            document.documentElement.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);
        });

        // Animate the circular clip path
        transition.ready.then(() => {
            const clipPath = [
                `circle(0px at ${x}px ${y}px)`,
                `circle(${endRadius}px at ${x}px ${y}px)`,
            ];

            document.documentElement.animate(
                {
                    clipPath: clipPath,
                },
                {
                    duration: 500,
                    easing: "ease-in-out",
                    pseudoElement: "::view-transition-new(root)",
                },
            );
        });
    };
</script>
