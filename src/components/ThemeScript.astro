---
/*
  ThemeScript.astro
  Handles theme initialization and toggling with View Transitions API support.
  Uses horizontal wipe transition for theme changes.
*/
---

<script is:inline>
    // Initialize theme
    const getTheme = () =>
        localStorage.getItem("theme") ||
        (window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light");

    document.documentElement.setAttribute("data-theme", getTheme());

    // Toggle theme function
    window.toggleTheme = () => {
        const current = document.documentElement.getAttribute("data-theme");
        const next = current === "light" ? "dark" : "light";

        // Fallback for browsers without View Transitions
        if (!document.startViewTransition) {
            document.documentElement.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);
            return;
        }

        const isDark = next === 'dark';

        // Start the transition
        const transition = document.startViewTransition(() => {
            document.documentElement.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);
        });

        // Horizontal wipe animation using clip-path inset
        // To dark: wipe from right to left
        // To light: wipe from left to right
        transition.ready.then(() => {
            const clipPath = isDark
                ? ['inset(0 100% 0 0)', 'inset(0 0 0 0)']  // right to left
                : ['inset(0 0 0 100%)', 'inset(0 0 0 0)']; // left to right

            document.documentElement.animate(
                { clipPath },
                {
                    duration: 400,
                    easing: "ease-in-out",
                    pseudoElement: "::view-transition-new(root)",
                },
            );
        });
    };
</script>

<style is:global>
    /* Disable default view transition animations */
    ::view-transition-old(root),
    ::view-transition-new(root) {
        animation: none;
        mix-blend-mode: normal;
    }

    /* New view always on top for wipe effect */
    ::view-transition-new(root) {
        z-index: 2;
    }
    ::view-transition-old(root) {
        z-index: 1;
    }
</style>
