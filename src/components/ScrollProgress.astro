<div class="scroll-progress" data-scroll-progress>
  <div class="scroll-progress__track">
    <div class="scroll-progress__bar"></div>
  </div>
</div>

<style>
  :global(.scroll-progress) {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px;
    z-index: 1000;
    pointer-events: none;
  }

  .scroll-progress__track {
    width: 100%;
    height: 100%;
    background: rgba(23, 28, 38, 0.08);
  }

  .scroll-progress__bar {
    width: 100%;
    height: 100%;
    background: var(--color-accent, #e5fc81);
    transform-origin: left center;
    transform: scaleX(0);
    transition: transform 0.1s linear;
    will-change: transform;
  }

  /* Smooth transition when content size changes significantly */
  .scroll-progress__bar.is-adjusting {
    transition: transform 0.4s cubic-bezier(0.2, 0, 0.2, 1);
  }

  @media (prefers-reduced-motion: reduce) {
    .scroll-progress__bar {
      transition: none;
    }
  }
</style>

<script>
  if (typeof window !== "undefined") {
    const bar = document.querySelector(
      "[data-scroll-progress] .scroll-progress__bar",
    );

    if (bar instanceof HTMLElement) {
      const update = () => {
        const max = document.documentElement.scrollHeight - window.innerHeight;
        const percent = max > 0 ? window.scrollY / max : 0;
        bar.style.transform = `scaleX(${Math.min(Math.max(percent, 0), 1)})`;
      };

      let frame = 0;
      const scheduleUpdate = () => {
        if (frame) return;
        frame = window.requestAnimationFrame(() => {
          update();
          frame = 0;
        });
      };

      window.addEventListener("scroll", scheduleUpdate, { passive: true });
      window.addEventListener("resize", scheduleUpdate);

      // Monitor content height changes
      let lastScrollHeight = document.documentElement.scrollHeight;

      const resizeObserver = new ResizeObserver(() => {
        const currentScrollHeight = document.documentElement.scrollHeight;

        // If height changed significantly (more than 100px), animate the change
        if (Math.abs(currentScrollHeight - lastScrollHeight) > 100) {
          bar.classList.add("is-adjusting");
          update();

          // Remove class after transition
          setTimeout(() => {
            bar.classList.remove("is-adjusting");
          }, 400);
        } else {
          update();
        }

        lastScrollHeight = currentScrollHeight;
      });

      resizeObserver.observe(document.body);

      update();

      document.addEventListener("astro:after-swap", () => {
        scheduleUpdate();
        resizeObserver.observe(document.body);
      });
      document.addEventListener("astro:page-load", scheduleUpdate);
    }
  }
</script>
